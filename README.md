# SPARK #

Утилита для принтера Spark-115f с интерфейсом управления RS232

### Файлы проекта:

```
* Makefile      - файл сценария компиляции

* functions.c   - библиотека используемых функций (source)

* functions.h   - файл заголовков библиотеки функций (header)

* client.c      - поддержка tcp клиента для связи с ОФД (source)

* client.h      - файл заголовков tcp клиента (header)

* names.c       - парсер-функции статусов выполнения команд (текстовое наименование ошибок)

* main.c        - собственно файл утилиты (main)

* README.md     - файл описания проекта
```

### Параметры порта RS232 (/dev/ttyUSB0,...)

```
57600 8E1
hardware/software control off
```

### Поддерживаемые скорости порта RS232

* 4800
* 9600
* 19200
* 38400
* 57600 - default
* 115200


### Вызов утилиты

./spark --dev=/dev/ttyUSB0 --cmd=set_speed --arg=57600 --log=on --speed=57600


### Утилита возвращает следующие коды результата работы

* -1 - RET_MAJOR_ERROR
*  0 - RET_OK
*  1 - RET_MINOR_ERROR
*  2 - RET_TIMEOUT
*  3 - RET_NAK
*  4 - RET_ENQ


### Исполняемые команды и аргументы к ним
    Все команды и аргументы к ним представляют собой символьные строки (на это указывает символ ")

```
 1 "set_speed"                 - установка параметров порта rs232 (аргумент : скорость, например "9600").
 2 "set_password"              - ввод пароля управления ККТ (агрумент : пароль, например “012345”).
 3 "shift_open"                - открытие смены (аргумент : номер кассы,пароль кассира, например "99^99999").
 4 "shift_close"               - закрытие смены (аргумент : "empty").
 5 "set_cashier_number"        - программирование номера кассы (аргумент : номер кассы, от "01" до "99").
 6 "set_cashier_name_password" - программирование имени и пароля кассира (аргумент : код кассы,пароль,имя; например "01^00001^имя кассира").
 7 "register_cashier"          - регистрация кассира (аргумент : пароль кассира; например "99999").
 8 "reset_cashier"             - сброс кассира (аргумент : "empty").
 9 "clear_error"               - исправление ошибки (аргумент : "empty").
10 "line0_print"               - печать строки текстового документа (аргумент : текст; например "пример текста").
11 "line1_print"               - печать строки текстового документа с подчеркиванием (аргумент : текст; например "пример текста").
12 "end_of_print"              - закрыть печать текстового документа (аргумент : "empty").
13 "request_status"            - запрос статусов ККТ (аргумент : тип статуса - "base", "additional", "combined").
                                 (размерность ответа - 4 байта - int:
                                  "base"       : 0Y 00 CT2 CT1, где Y=1 при ошибке CRC8
                                  "additional" : 0Y 00 CT4 CT3, где Y=1 при ошибке CRC8
                                  "combined"   : 0Y CT3 CT2 CT1, где Y=1 при ошибке CRC8)
14 "restart_device"            - Используется для перезапуска ККТ в случае её “зависания” (аргумент : "empty")
15 "general_report"            - Распечатка общего отчёта по программированию (аргумент : "empty")
16 "set_coming_item"           - Приход : ввод и печать номера заказа (аргумент : номер заказа, не более 3 символов).
17 "set_return_item"           - Возврат : ввод и печать номера заказа (аргумент : номер заказа, не более 3 символов).
18 "return_item"               - Возврат товара (аргумент : Тип налога[1],Цена[8],Количество[8],Отдел[2],Наименование[N]; например "a^00000123^00000001^01^Товар")
19 "storno_return_item"        - Возврат товара (аргумент : Тип налога[1],Цена[8],Количество[8],Отдел[2],Наименование[N]; например "a^00000123^00000001^01^Товар")
                                (Тип налога : 'a'..'f' - ставка налога № 1..№6)
20 "end_of_return_item"        - Завершение операции возврата товара (аргумент : Вид оплаты[1],Сумма[10]; например "1^0000000056")
21 "reg_item"                  - Регистрации товарной позиции (аргумент : НДС[1],Цена[8],Количество[8],Отдел[2],Наименование[N]; например, "3^00000123^00000001^01^Товар")
22 "storno_item"               - Сторнирования товарной позиции (аргумент : НДС[1],Цена[8],Количество[8],Отдел[2],Наименование[N]; например, "3^00000123^00000001^01^Товар")
                                (НДС: '0' - НДС не облагается,
                                      '1','2'- НДС рассчитанный внутри стоимо-сти товара,
                                      '3' - НДС 0%,
                                      '4','5' - НДС рассчитанный поверх стоимости товара)
23 "end_of_chek"               - Завершение операции (чека) (аргумент : ВИД ОПЛАТЫ[1]; например : "1")
24 "end_of_pay"                - Завершение операции оплаты (аргумент : ВИД ОПЛАТЫ[1]; например : "8")
                                (ВИД ОПЛАТЫ: Наличные ‘8’, Кредит ‘7’, Чек ‘6’, Платёжные карты ‘1’~’5’)
25 "request_statFN"            - Запрос состояния ФН (аргумент : "empty")
26 "error_reset"               - Сброс ошибки : конец ленты или сбой принтера (аргумент : "empty")
27 "get_stat_exch"             - Получить статус информационного обмена (аргумент : "empty")
                                (в ответ на эту команду возвращается количество сообщений для передачи в ОФД или -1 при ошибке)
28 "text_report0_print"        - Печать текстового отчёта (аргумент : Чек,Текстовая строка; например : "0^Текст")
29 "text_report1_print"        - Печать текстового отчёта с подчеркиванием (аргумент : Чек,Текстовая строка; например : "1^Текст")
                                (Чек : '0' - без завершения чека, '1' - с завершением чека)
30 "extra_lines_print"         - Печать дополнительных строк в окончании чека (аргумент : Текстовая строка[42]; например : "Текст")
31 "cancel_chek"               - Аннулирование текущего, открытого чека (аргумент : "empty")
32 "last_doc_print"            - Выдача дубликата последнего документа (печать) (аргумент : "empty")
33 "last_doc_bin"              - Выдача дубликата последнего документа (в электронном виде) (аргумент : "empty")
34 "get_ver_software"          - Считывание номера версии (аргумент : "empty")
35 "set_text attr"             - Программирование значений текстовых реквизитов (аргумент : Номер реквизита,Текстовая строка; например : "03^495-555-55-55")
36 "read_reg_data"             - Прочитать данные регистрации/перерегистрации (аргумент : Номер регистрации; например : "0" - первичная регистрация)
37 "before_exch"               - Передать статус транспортного соединения с Сервером ОФД (аргумент : Статус соединения; "0" - разорвано, "1" - установлено)
38 "get_S1"                    - Считывание информации S1 (аргумент : "empty")
39 "begin_read_msg"            - Начать чтение Сообщения для Сервера ОФД (аргумент : "empty")
40 "close_chek"                - Итог внесений/выплат, завершение кассового чека (аргумент : "nocat" - блокирует обрезку чека, "def" с отрезкой чека)
41 "info_about_done"           - Считывание информации по итогам смены (основные данные) (аргумент : Тип информации)
                                 (аргумент : "shift" - Для получения информации по итогам смены, "general" - Для получения информации по общим итогам)
42 "extra_info_about_done"     - Считывание информации по итогам смены (дополнительные данные) (аргумент : Тип информации)
                                 (аргумент : "shift" - Для получения информации по итогам смены, "general" - Для получения информации по общим итогам)

43 "read_msg_block"            ? Прочитать блок сообщения для сервера ОФД (аргумент : смещение, например "0"; "0".."65536")
44 "cancel_exch"               ? Отменить чтение Сообщения для Сервера ОФД (аргумент : "empty")
45 "close_exch"                ? Завершить чтение Сообщения для Сервера ОФД (аргумент : "empty")
46 "ack_srv"                   ? Передать квитанцию от сервера ОФД (аргумент : bin data from server)

    ? - команды не должны применяться с верхнего уровня (реализованы только для передачи документов на сервер ОФД) !!!

47 "send_test"                 - Послать пустое тестовое сообщение сереверу ОФД - проверка связи ( аргументы : --arg=abubariba.com:7778 --mode=list )
48 "send_msg"                  - Отправить серверу ОФД одно сообщение (аргументы : --arg=abubariba.com:7778 --mode=list)
                                 (в ответ на эту команду возвращается количество сообщений для передачи в ОФД или значение меньше 0 при ошибке)
```


### Утилита имеет несколько уровней логирования (печати на stdout и в лог-файл)

* LOG_OFF   - логирование выключено, за исключением записи в syslog start/stop сообщений
* LOG_ON    - логирование включено, основной режим логирования
* LOG_DEBUG - логирование включено, расширенный режим логирования
* LOG_DUMP  - логирование включено, полный режим логирования


### P.S.

```
* Добавлен необязательный параметр ожидания выполения команды, задается при старте утилиты : --timeout=X , X=3... (в сек.)
* Утилита пишет лог-файл "/tmp/spark_log.txt" (не более 32M), а также в syslog start/stop сообщения
* Утилита 'видит' следующие сигналы : SIGPIPE, SIGTERM, SIGINT, SIGKILL, SIGSEGV, SIGABRT, SIGSYS, SIGTRAP
```


